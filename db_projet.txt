BEGIN

   BEGIN
      EXECUTE IMMEDIATE 'DROP VIEW V_STATISTIQUES';
   EXCEPTION
      WHEN OTHERS THEN NULL;
   END;


   EXECUTE IMMEDIATE 'DROP TABLE T_AVIS CASCADE CONSTRAINTS';
   EXECUTE IMMEDIATE 'DROP TABLE T_EMPRUNT CASCADE CONSTRAINTS';
   EXECUTE IMMEDIATE 'DROP TABLE T_MEMBRE CASCADE CONSTRAINTS';
   EXECUTE IMMEDIATE 'DROP TABLE T_EXEMPLAIRE CASCADE CONSTRAINTS';
   EXECUTE IMMEDIATE 'DROP TABLE T_OUVRAGE CASCADE CONSTRAINTS';
   EXECUTE IMMEDIATE 'DROP TABLE T_CERCLE CASCADE CONSTRAINTS';
   EXECUTE IMMEDIATE 'DROP TABLE T_UTILISATEUR CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN NULL;
END;
/


CREATE TABLE T_UTILISATEUR (
    id_user NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nom VARCHAR2(50) NOT NULL,
    prenom VARCHAR2(50) NOT NULL,
    email VARCHAR2(100) UNIQUE NOT NULL,
    mot_de_passe VARCHAR2(100) NOT NULL,
    adresse VARCHAR2(200)
);

CREATE TABLE T_CERCLE (
    id_cercle NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nom_cercle VARCHAR2(100) NOT NULL,
    description VARCHAR2(255)
);


CREATE TABLE T_OUVRAGE (
    isbn13 VARCHAR2(13) PRIMARY KEY,
    titre VARCHAR2(150),
    auteur VARCHAR2(100),
    editeur VARCHAR2(100)
);

CREATE TABLE T_MEMBRE (
    id_user NUMBER(10),
    id_cercle NUMBER(10),
    role VARCHAR2(20) DEFAULT 'MEMBRE' CHECK (role IN ('CHEF', 'MEMBRE')),
    statut VARCHAR2(20) DEFAULT 'ATTENTE' CHECK (statut IN ('ATTENTE', 'VALIDE', 'REFUSE')),
    CONSTRAINT PK_MEMBRE PRIMARY KEY (id_user, id_cercle),
    CONSTRAINT FK_MEMBRE_USER FOREIGN KEY (id_user) REFERENCES T_UTILISATEUR(id_user),
    CONSTRAINT FK_MEMBRE_CERCLE FOREIGN KEY (id_cercle) REFERENCES T_CERCLE(id_cercle)
);


CREATE TABLE T_EXEMPLAIRE (
    id_exemplaire NUMBER(10) GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    id_user NUMBER(10) NOT NULL,
    isbn13 VARCHAR2(13) NOT NULL,
    etat VARCHAR2(50),
    localisation VARCHAR2(100),
    est_pretable NUMBER(1) DEFAULT 1 CHECK (est_pretable IN (0,1)), 
    est_disponible NUMBER(1) DEFAULT 1 CHECK (est_disponible IN (0,1)), 
    CONSTRAINT FK_EXEMP_USER FOREIGN KEY (id_user) REFERENCES T_UTILISATEUR(id_user),
    CONSTRAINT FK_EXEMP_ISBN FOREIGN KEY (isbn13) REFERENCES T_OUVRAGE(isbn13)
);

CREATE TABLE T_EMPRUNT (
    id_user NUMBER(10),
    id_exemplaire NUMBER(10),
    date_demande DATE DEFAULT SYSDATE,
    date_debut DATE,
    date_fin DATE,
    statut_emprunt VARCHAR2(20) DEFAULT 'DEMANDE',
    CONSTRAINT PK_EMPRUNT PRIMARY KEY (id_user, id_exemplaire, date_demande),
    CONSTRAINT FK_EMP_USER FOREIGN KEY (id_user) REFERENCES T_UTILISATEUR(id_user),
    CONSTRAINT FK_EMP_EXEMP FOREIGN KEY (id_exemplaire) REFERENCES T_EXEMPLAIRE(id_exemplaire)
);

CREATE TABLE T_AVIS (
    id_user NUMBER(10),
    isbn13 VARCHAR2(13),
    note NUMBER(2) CHECK (note BETWEEN 0 AND 5),
    commentaire VARCHAR2(500),
    date_avis DATE DEFAULT SYSDATE,
    CONSTRAINT PK_AVIS PRIMARY KEY (id_user, isbn13),
    CONSTRAINT FK_AVIS_USER FOREIGN KEY (id_user) REFERENCES T_UTILISATEUR(id_user),
    CONSTRAINT FK_AVIS_ISBN FOREIGN KEY (isbn13) REFERENCES T_OUVRAGE(isbn13)
);


CREATE OR REPLACE TRIGGER TRG_MAJ_DISPO
AFTER UPDATE OF date_debut ON T_EMPRUNT
FOR EACH ROW
BEGIN
    IF :NEW.date_debut IS NOT NULL THEN
        UPDATE T_EXEMPLAIRE
        SET est_disponible = 0
        WHERE id_exemplaire = :NEW.id_exemplaire;
    END IF;
END;
/


CREATE OR REPLACE VIEW V_STATISTIQUES AS
SELECT
    (SELECT COUNT(*) FROM T_UTILISATEUR) AS nb_utilisateurs_total,
    (SELECT COUNT(DISTINCT isbn13) FROM T_EXEMPLAIRE) AS nb_livres_differents,
    (SELECT COUNT(*) FROM T_EMPRUNT) AS nb_prets_realises,
    (SELECT COUNT(*) FROM T_EMPRUNT WHERE statut_emprunt = 'EN_COURS') AS nb_prets_actifs
FROM DUAL;


CREATE OR REPLACE PROCEDURE AJOUTER_USER 
(
    p_nom IN VARCHAR2, 
    p_prenom IN VARCHAR2, 
    p_email IN VARCHAR2, 
    p_mdp IN VARCHAR2
) 
IS
BEGIN
    INSERT INTO T_UTILISATEUR (nom, prenom, email, mot_de_passe) 
    VALUES (p_nom, p_prenom, p_email, p_mdp);
    COMMIT;
END;
/
